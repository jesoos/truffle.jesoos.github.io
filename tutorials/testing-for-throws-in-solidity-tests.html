<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- Favicon -->
    <link rel="icon" href="/img/favicons/favicon.ico">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Truffle Suite">
    <link rel="icon" sizes="192x192" href="/img/favicons/chrome-touch-icon-192x192.png">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Truffle Suite">
    <link rel="apple-touch-icon" href="/img/favicons/apple-touch-icon.png">

    <!-- Tile icon for Win8/10 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="img/favicons/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <!-- Facebook OpenGraph -->
    <meta property="og:site_name" content="Truffle Suite" />
    <meta property="og:description" content="The Truffle suite of tools make dapp development easier and more consistent." />
    <meta property="og:title" content="Truffle Suite | Tutorials | Testing for throws in Solidity Tests" />
    <meta property="og:url" content="https://trufflesuite.com/tutorials/testing-for-throws-in-solidity-tes" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="https://truffleframework.com/img/favicons/truffle-share.png" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="Truffle Suite" />
    <meta name="twitter:title" content="Truffle Suite | Tutorials | Testing for throws in Solidity Tests" />
    <meta name="twitter:description" content="The Truffle suite of tools make dapp development easier and more consistent." />
    <meta name="twitter:creator" content="Truffle Suite" />
    <meta name="twitter:domain" content="trufflesuite.com" />
    <meta name="twitter:image:src" content="https://truffleframework.com/img/favicons/truffle-share.png" />
    
    <meta name="google-site-verification" content="BSgPkMHzw7IxJTpEElNfD8ZZYPzXgOQiTVPzAxAG8-o" />
      
    <title>Truffle Suite | Tutorials | Testing for throws in Solidity Tests</title>

    <link href="https://fonts.googleapis.com/css?family=Grand+Hotel|Open+Sans|Oswald|Varela+Round|Roboto+Condensed|Roboto+Mono" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/index.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top" id="primaryNav">
      <a class="navbar-brand current" href="/">
        <img class="suite-logo" src="/img/truffle-logomark.svg" alt="Truffle Logo" />TRUFFLE SUITE
      </a>
    
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    
      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="suiteDropdown" href="#" data-toggle="dropdown">SUITE</a>
    
            <div class="dropdown-menu">
              <a class="text-truffle" href="/truffle">
                <img class="suite-logo" src="/img/truffle-logomark.svg" alt="Truffle Logo" /><span class="narrow">T</span>RUFFLE
              </a>
              <a class="text-ganache" href="/ganache">
                <img class="suite-logo" src="/img/ganache-logomark.svg" alt="Ganache Logo" />Ganache
              </a>
              <a class="text-drizzle" href="/drizzle">
                <img class="suite-logo" src="/img/drizzle-logomark.svg" alt="Drizzle Logo" />dri<span class="drizzle-z-skew-1">z</span><span class="drizzle-z-skew-2">z</span>le
              </a>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/docs">DOCS</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/tutorials">TUTORIALS</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/boxes">BOXES</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/blog">BLOG</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/community">COMMUNITY</a>
          </li>
        </ul>
      </div>
    </nav>
    <main class="container container-heading container-narrow">
      <div class="row">
        <div class="col">
          <h1>Testing for throws in Solidity Tests</h1>
          <ul class="list-sm-stacker space-icon mb-0">
            <li><i class="far fa-calendar-alt"></i> 2017-02-13&nbsp;&nbsp;&nbsp;</li>
            <li><i class="far fa-user"></i> Simon de la Rouviere</li>
          </ul>
        </div>
      </div>
    </main>

    <main class="banner banner-light-cream pt-5 pb-5" role="main">
      <div class="container container-post">
        <div class="row justify-content-center">
          <div class="col">
            <p><br/><p class="alert alert-warning" style="margin-top: -2rem; margin-bottom: 3rem;">
  <strong>NOTE</strong>: This tutorial is written for versions of Solidity prior to v0.4.13. It relies on the deprecated <code>throw</code> keyword, now replaced by <code>revert()</code>, <code>require()</code>, and <code>assert()</code>. See Solidity documentation for <a href="http://solidity.readthedocs.io/en/develop/control-structures.html?highlight=require#error-handling-assert-require-revert-and-exceptions">error handling</a> for more information.
</p></p>
<p>Truffle 3 brings forth Solidity unit testing, which means one can now test contracts in Solidity itself. This is a boon to contract developers, as there are several reasons why it&#39;s useful to have Solidity tests in addition to Truffle’s Javascript tests. For us at <a href="https://ujomusic.com/">Ujo</a>, one of our biggest concerns is testing how contracts interact with each other, rather than just testing their interaction from a web3 perspective, and Solidity tests allow us to do that.</p>
<p>Though Solidity tests can be quite powerful, they do come with some drawbacks. One of those is testing whether or not a function should <code>throw</code> (without breaking the test!), which I&#39;ll show you how to do right now.</p>

    <h2 class="link-markdown">
      <a href="#diving-in" name="diving-in"><i class="fas fa-link"></i></a>
      Diving In
    </h2>
  <p>In Solidity, when performing a contract call that produces an error, Solidity automatically rethrows, meaning it will bubble that error up to the caller. However, with a <em>raw</em> call, the behavior is different: one can catch the error and decide what to do from there on out. If it throws (fails), it will return <code>false</code>. If it succeeds, it will return <code>true</code>. Thus, the following calls will produce a different result.</p>
<pre><code class="lang-javascript">// Returns false
bool result = address.call(bytes4(bytes32(sha3(“functionThatThrows()”))));

// Returns true
bool result = address.call(bytes4(bytes32(sha3(“functionThatDoesNotThrow()”))));
</code></pre>
<p>When calls are made this way, even if a sub-call fails, it won’t automatically rethrow.</p>
<p>In order to test for throws, one can either write out each call in the format above (which is cumbersome), or use a proxy contract to wrap the contract call to a raw call and return whether it succeeded or not.</p>
<p>For our purposes, let&#39;s look at the example below, similar to a method I saw used by Dapple in a Tester contract. Note that these contracts will likely be placed in separate files within your Truffle project. Here, <code>Thrower</code> is the contract you&#39;re testing to see whether or not certain contracts <code>throw</code>, <code>ThrowProxy</code> is our helper and <code>TestThrower</code> is our test contract.</p>
<p>The code is as follows:</p>
<pre><code class="lang-javascript">import &quot;truffle/Assert.sol&quot;;

// Proxy contract for testing throws
contract ThrowProxy {
  address public target;
  bytes data;

  function ThrowProxy(address _target) {
    target = _target;
  }

  //prime the data using the fallback function.
  function() {
    data = msg.data;
  }

  function execute() returns (bool) {
    return target.call(data);
  }
}

// Contract you&#39;re testing
contract Thrower {
  function doThrow() {
    throw;
  }

  function doNoThrow() {
    //
  }
}

// Solidity test contract, meant to test Thrower
contract TestThrower {
  function testThrow() {
    Thrower thrower = new Thrower();
    ThrowProxy throwProxy = new ThrowProxy(address(thrower)); //set Thrower as the contract to forward requests to. The target.

    //prime the proxy.
    Thrower(address(throwProxy)).doThrow();
    //execute the call that is supposed to throw.
    //r will be false if it threw. r will be true if it didn&#39;t.
    //make sure you send enough gas for your contract method.
    bool r = throwProxy.execute.gas(200000)();

    Assert.isFalse(r, “Should be false, as it should throw”);
  }
}

</code></pre>
<p>Perhaps the most interesting line is the following:</p>
<pre><code class="lang-javascript">Thrower(address(throwProxy)).doThrow();
</code></pre>
<p>This is telling Solidity to call the <code>doThrow()</code> function at the <code>throwProxy</code> address. Solidity automatically creates the necessary message data (<code>msg.data</code>) based on this call. Writing it like this, one would assume that at <code>throwProxy</code> there <em>is</em> a Thrower contract, but there isn’t. There&#39;s a proxy instead. The proxy then receives the msg data, and since it doesn’t have a <code>doThrow()</code> function, the fallback function is triggered in its place.</p>
<p>The fallback function then saves the message data. After that, when executing the proxy, it then forwards the request onwards as a raw call, not a contract call. Since the <code>throw</code> would use up all the gas, the rest of the tests would legitimately OOG, so we restrict the gas sent through when calling the <code>execute()</code> method. Note that enough should be sent through so that it doesn’t OOG legitimately and thus miss the actual throw condition.</p>
<p>With this proxy, one can still effectively write the interactions as contracts calling other contracts without having to resort to crafting raw calls manually. (Hooray!)</p>

    <h2 class="link-markdown">
      <a href="#gotchas" name="gotchas"><i class="fas fa-link"></i></a>
      Gotchas
    </h2>
  <p>An important caveat here is to recognize the contract caller, <code>msg.sender</code>. If you add a proxy in between, then <code>msg.sender</code> will be the proxy, which could break authorization and permissioning algorithms. If your authorization system allows you to change the owner, you can get around this constraint by setting the proxy to be the contract owner. For example:</p>
<pre><code class="lang-javascript">// Assume our contract under test has a changeOwner() function
thrower.changeOwner(address(throwProxy));

// Perform test functions and assertions
// ...

// Restore previous owner
Thrower(address(throwProxy)).changeOwner(address(this));
throwProxy.execute();
</code></pre>
<p>It’s also important to know that this only tests <code>throw</code>&#39;s at this particular level. For instance, if your contract call structure looked like the following:</p>
<pre><code class="lang-shell">Test -&gt; Proxy -&gt; ContractToTest -&gt; SomeOtherContract -&gt; AnotherContractThatThrows
</code></pre>
<p>Then you wouldn’t know where the <code>throw</code> occurred, since SomeOtherContract and ContractToTest could just rethrow.</p>
<p>It would be prudent to also ensure there isn’t anything faulty in the proxy by creating a second test as a control. This test should be called with the appropriate gas and use the proxy to test a function where _no_ <code>throw</code> occurs, just to make sure the proxy is setup and working as intended.</p>
<p>Because a <code>throw</code> essentially uses up all gas, one must make doubly sure they catch the <code>throw</code> and <strong>not</strong> a legitimate out-of-gas (OOG) error. As well, take care to manage sending Ether through the proxy (for tests that require it) as that can be difficult as well.</p>

    <h2 class="link-markdown">
      <a href="#conclusion" name="conclusion"><i class="fas fa-link"></i></a>
      Conclusion
    </h2>
  <p>Testing <code>throws</code> is possible from within Solidity tests, but can be cumbersome if you want to write those tests yourself as raw calls. You can get around this by using a proxy contract, which makes many situations a lot easier and makes your tests much easier to write. But keep a look out for potential caveats as Solidity tests with a lot more power but plenty of drawbacks.</p>
<p>Happy developing!</p>
<hr>
<p>
    <img class="img-fluid" src="https://consensys.net/img/team/simon.jpg" title="About Simon de la Rouviere" alt="About Simon de la Rouviere" />
    
  </p>
<p>About Simon de la Rouviere</p>
<p>Simon builds decentralised applications for use in the music industry, online communities and the developing world. He has been in the Bitcoin/blockchain space since 2011, developed a decentralised band around a full blown cryptocurrency, and is writing a book on the blockchain. More about Simon can be found on <a href="https://consensys.net/team/">consensys.net</a>.</p>


            <div class="contribute-link">
              See a way to make this page better? <a href="https://github.com/trufflesuite/trufflesuite.com/edit/master/src/tutorials">Edit here &raquo;</a>
            </div>          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-12 col-md-2 mb-4 mb-md-0">
            <img class="truffle-logo" src="/img/truffle-logo-light.svg" alt="Truffle Logo" />
          </div>
    
          <div class="col-12 col-md-5 mb-3 mb-md-0">
            <ul>
              <!--<li><a href="/careers">CAREERS</a></li>-->
              <li><a href="mailto:inquiry@trufflesuite.com">CONTACT US</a></li>
              <li><a href="/policy">PRIVACY POLICY</a></li>
              <li><a href="/dashboard">DASHBOARD</a></li>
              <li><a href="https://github.com/trufflesuite">GITHUB</a></li>
              <li><a href="https://twitter.com/trufflesuite">TWITTER</a></li>
              <li><a class="trufflecon-link" href="/trufflecon2018">TRUFFLEC<img src="/img/truffle-logomark.svg" alt="Truffle Logo" /><span>O</span>N 2018</a></li>
              <li class="text-truffle">
                <a href="https://new.consensys.net/">
                  <img class="consensys-logomark" src="/img/consensys-logomark.svg" alt="ConsenSys Logo" />
                  &copy; CONSENSYS 2018
                </a>
              </li>
            </ul>
          </div>
    
          <div class="col-12 col-md-5">
            <h4>SIGN UP FOR THE TRUFFLE MAILING LIST</h4>
            <form>
              <div class="form-group">
                <input type="email" class="form-control" id="footerMailingEmail" placeholder="Email Address">
              </div>
              <div class="form-group">
                <input type="text" class="form-control" id="footerMailingFirstName" placeholder="First Name">
                <small id="firstNameHelp" class="form-text text-muted">So we know how to address you.</small>
              </div>
              <button type="submit" class="btn btn-truffle">SUBSCRIBE</button>
            </form>
          </div>
        </div>
      </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="/js/vendor/jquery-3.2.1.slim.min.js"><\/script>')</script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/vendor/prism.js"></script>
    <script src="/js/markdown-cleanup.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-83874933-3', 'auto');
      ga('send', 'pageview');
    </script>  </body>
</html>